name: Create Artist Remove PR

on:
  workflow_call:

jobs:
  create_pr:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Install dependencies
        run: npm ci

      - name: Mark artist as removed
        id: remove_file
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          COMMENT_ID: ${{ github.event.comment.id }}
        run: node .github/scripts/create-artist-remove-pr.js

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: 'Mark ${{ steps.remove_file.outputs.artist_name }} as removed'
          branch: ${{ steps.remove_file.outputs.branch_name }}
          create_branch: true
          file_pattern: 'src/'
          commit_options: '--no-verify'
          push_options: '--force' # in case of branch name already exists

      - name: Create PR
        uses: actions/github-script@v7
        env:
          ARTIST_NAME: ${{ steps.remove_file.outputs.artist_name }}
          ARTIST_ID: ${{ steps.remove_file.outputs.artist_id }}
          BRANCH_NAME: ${{ steps.remove_file.outputs.branch_name }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        with:
          script: |
            const artistName = process.env.ARTIST_NAME;
            const artistId = process.env.ARTIST_ID;
            const branchName = process.env.BRANCH_NAME;
            const issueNumber = process.env.ISSUE_NUMBER;

            // Create the PR
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Remove ${artistName}`,
              head: branchName,
              base: 'main',
              body: `This PR marks the artist **${artistName}** (${artistId}.json) as removed.\n\nCreated from issue #${issueNumber}`
            });

            console.log(`PR created: ${pr.html_url}`);

            // Add a comment to the issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `âœ… PR created: ${pr.html_url}`
            });
